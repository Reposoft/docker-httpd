version: '2'
services:
  gitclient.build:
    build: ../gitclient
    image: httpd-gitclient
    entrypoint: ["echo", "This service was just a build job. Exiting."]
  git.build:
    build: ../git
    depends_on:
      - gitclient.build
    image: httpd-git
    entrypoint: ["echo", "This service was just a build job. Exiting."]
  githost:
    build: ./githost
    depends_on:
      - git.build
    ports:
      - "80"
  httpd:
    build: ../httpd-gitconf
    image: httpd-gitconf
    volumes:
      - ./gitconf-test:/gitconf-test
    entrypoint: /gitconf-test/httpd-entrypoint.sh
  conftest:
    image: httpd-gitclient
    depends_on:
      - gitclient.build
    labels:
      com.yolean.build-contract: "*"
    volumes:
      - ./gitconf-test:/gitconf-test
    entrypoint: /gitconf-test/reconf-test.sh
  # if this container stops the test should fail, so it can't terminate like a com.yolean.build-contract
  uptest:
    image: httpd-gitclient
    depends_on:
      - gitclient.build
    volumes:
      - ./gitconf-test:/gitconf-test
    entrypoint: /gitconf-test/up-test.sh
